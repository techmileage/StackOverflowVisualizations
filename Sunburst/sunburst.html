<html>
    <head>
        <meta charset="utf-8"/>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <link rel="stylesheet" href="sunburst.css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:100i|Roboto:100" rel="stylesheet">
    </head>
    <body>
        <div class="header">
            <h1>
                Question Traffic HeatMap Clock<br/><br/><br/><br/><br/><br/>
            </h1>
        </div>
        <div class="legend">
        </div>
        <div class="chart"></div>
    </body>
    <script>
        var back_ground_color = "#f69c55";
        d3.select('body').style("background-color",back_ground_color);
        d3.select(".logo").style("background-color", "#99ffff");
        d3.select(".legend").append("table")
            .attr("id", "legend_table");
            
        var table = d3.select(".legend").select("table");
        //table.attr("cellpadding","10");
        var rep_line, inner_select, middle_select, outter_select, yMin, yMax, yScale, yScaleWeek, yScaleDay, hist, outter_circle, middle_circle, inner_circle, yMinWeek, yMaxWeek, yMinDay, yMaxDay;
        var total = 0;
        var hour_data = [];
        var day_data = [];
        var week_data = [];
        var month_data = [];
        for(i = 0; i < 8760; i++)
            hour_data.push([i,0]);
        for(i = 0; i < 365; i++)
            day_data.push([i, 0]);
        for(i = 0; i < 52; i++)
            week_data.push([i, 0]);
        for(i = 0; i < 12; i++){
            for(j = 0; j < 4; j++)
                week_data.push([i*4+j+52, 0]);
            month_data.push([i,0]);
        }

        var cycle_data = [[],[],[],[],[],[],[],[],[],[],[],[],[],[]];
        var week_cycle_data = [[],[],[],[],[],[],[],[],[],[],[],[],[],[]];
        for(j = 0; j < 14; j++){
            for(i = 0; i < 168; i++)
                cycle_data[j].push([i, 0]);
            for(i = 0; i < 7; i++)
                week_cycle_data[j].push([i,0])
        }

        var middle_min_idx, middle_max_idx, outter_min_idx, outter_max_idx, hist_min_idx, hist_max_idx;
        

        var outterQuarts = [0,0,0];
        var middleQuarts = [0,0,0];
        var innerQuarts = [0,0,0];
        var histQuarts = [0,0,0];
        var weekQuarts = [];
        var dayQuarts = [];
        for(i = 0; i < 14; i++){
            weekQuarts.push([0,0,0]);
            dayQuarts.push([0,0,0]);
        }
        
        var data = [];
        var days_per_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        var cum_days = [0, 0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
        var day_colors = ["#008000", "#800080", "#008080", "#800000", "#000080", "#804000", "#400080"];
        var heat_colors = ["#000099", "#4d0099", "#7a1f5c", "#990000"];
        var gone_colors = ["#b3b3ff", "#d9b3ff", "#f0c2e0", "#ffb3b3"];
        var select_color = "#009900";
        var margin = {top: 20, right: 20, bottom: 40, left: 40}
        , width = 1500 - margin.left - margin.right
        , height = 800 - margin.top - margin.bottom;
        var r = width*.7/4;
        var center = [width/4, height*0.9/2];
        var center2 = [width*3/4, height*0.9/2];
        var circumference = 2*Math.PI*r;
        var transition_time = 1000;
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'June', 'July', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        
        reset_select();
        var x = d3.scaleLinear()
            .domain([0,width])
            .range([0, width]);

        var y = d3.scaleLinear()
            .domain([0, height])
            .range([height, 0]);
    
        
        /*var line = d3.line()
            .x(function(d) { return x(d[0]); })
            .y(function(d) { return y(d[1]); })
            .curve(d3.curveCardinalClosed);*/

        var svg = d3.select(".chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var arc = d3.arc()
            .startAngle(function(d){return 2*(d[0]-d[4])*Math.PI/d[1];})
            .endAngle(function(d){
                if(d[0] >= d[4] && d[0] < d[5]){
                    return 2*(d[0]-d[4]+1)*Math.PI/d[1];
                }
                else
                    return 2*(d[0]-d[4])*Math.PI/d[1];
            })
            .outerRadius(function(d){return d[2];})
            .innerRadius(function(d){return d[3];})

        rep_line = svg.selectAll(".rep_line")
                .data(hour_data)
                .enter().append("g")
                .attr("class", "rep_line");
        rep_line.append("line")
            .attr("x1", center2[0]-r/2)
            .attr("x2", center2[0]+r/2)
            .attr("y1", center2[1])
            .attr("y2", center2[1])
            .attr("stroke", "black")
            .attr("stroke-width", "3")

        rep_data = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];
        rep_buts = svg.selectAll(".rep_but")
            .data(rep_data)
            .enter().append("g")
            .attr("class", "rep_but");
        rep_buts.append("circle")
            .attr("cx", function(d){
                return center2[0]+r*(d-6.5)/13;
            })
            .attr("cy", center2[1])
            .attr("r", function(d){
                if(d < 13)
                    return r*0.025
                return r*0.04
            })
            .attr("fill",function(d){
                if(d < 13)
                    return "#666666"
                return "#cc6600"
            })
            .on("click", function(d){
                filter_select(d);
            })
        
        svg.append("text")
            .attr("x", center2[0]+r*(-6.5)/13-5)
            .attr("y", .97*center2[1])
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("0");
        svg.append("text")
            .attr("x", center2[0]+r*(3-6.5)/13-5)
            .attr("y", .97*center2[1])
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("3");
        svg.append("text")
            .attr("x", center2[0]+r*(6-6.5)/13-5)
            .attr("y", .97*center2[1])
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("6");
        svg.append("text")
            .attr("x", center2[0]+r*(9-6.5)/13-5)
            .attr("y", .97*center2[1])
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("9");
        svg.append("text")
            .attr("x", center2[0]+r*(12-6.5)/13-8)
            .attr("y", .97*center2[1])
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("12");
        svg.append("text")
            .attr("x", center2[0]+r*(14-6.5)/13-8)
            .attr("y", center2[1]+5)
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("All");
        svg.append("text")
            .attr("x", center2[0]-100)
            .attr("y", center2[1]-50)
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("Filter by ln(reputation+1)");
        svg.append("text")
            .attr("x", center2[0]-r*0.25)
            .attr("y", center2[1]+r*1.3)
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("Click any filter.");
        svg.append("text")
            .attr("x", center[0]-r*0.25)
            .attr("y", center[1]+r*1.3)
            .attr("font-size", "20px")
            .attr("fill", "black")
            .text("Click any arc.");
        var day;
        d3.csv('time_data.csv', function(error, da){
            da.forEach(e => {
                Object.keys(e).forEach(k =>{
                    e[k] = parseInt(e[k]);
                })
                day = row_to_day(e)
                hour_data[day*24+e.Hour][1] = e.Count;
                day_data[day][1] += e.Count;
                day = row_to_week(e);
                if(day < 52)
                    week_data[day][1] += e.Count;
                day = Math.floor((e.Day-1)/7);
                if(day < 4)
                    week_data[(e.Month-1)*4+day+52][1] += e.Count;
                month_data[e.Month-1][1] += e.Count;
                cycle_data[0][e.WeekDay*24+e.Hour][1] += e.rep0;
                week_cycle_data[0][e.WeekDay][1] += e.rep0;
                cycle_data[1][e.WeekDay*24+e.Hour][1] += e.rep1;
                week_cycle_data[1][e.WeekDay][1] += e.rep1;
                cycle_data[2][e.WeekDay*24+e.Hour][1] += e.rep2;
                week_cycle_data[2][e.WeekDay][1] += e.rep2;
                cycle_data[3][e.WeekDay*24+e.Hour][1] += e.rep3;
                week_cycle_data[3][e.WeekDay][1] += e.rep3;
                cycle_data[4][e.WeekDay*24+e.Hour][1] += e.rep4;
                week_cycle_data[4][e.WeekDay][1] += e.rep4;
                cycle_data[5][e.WeekDay*24+e.Hour][1] += e.rep5;
                week_cycle_data[5][e.WeekDay][1] += e.rep5;
                cycle_data[6][e.WeekDay*24+e.Hour][1] += e.rep6;
                week_cycle_data[6][e.WeekDay][1] += e.rep6;
                cycle_data[7][e.WeekDay*24+e.Hour][1] += e.rep7;
                week_cycle_data[7][e.WeekDay][1] += e.rep7;
                cycle_data[8][e.WeekDay*24+e.Hour][1] += e.rep8;
                week_cycle_data[8][e.WeekDay][1] += e.rep8;
                cycle_data[9][e.WeekDay*24+e.Hour][1] += e.rep9;
                week_cycle_data[9][e.WeekDay][1] += e.rep9;
                cycle_data[10][e.WeekDay*24+e.Hour][1] += e.rep10;
                week_cycle_data[10][e.WeekDay][1] += e.rep10;
                cycle_data[11][e.WeekDay*24+e.Hour][1] += e.rep11;
                week_cycle_data[11][e.WeekDay][1] += e.rep11;
                cycle_data[12][e.WeekDay*24+e.Hour][1] += e.rep12;
                week_cycle_data[12][e.WeekDay][1] += e.rep12;
                cycle_data[13][e.WeekDay*24+e.Hour][1] += e.Count;
                week_cycle_data[13][e.WeekDay][1] += e.Count;
                total += e.Count;
            });
            
            svg.append("text")
                .attr("class", "left_text")
                .attr("x", center[0]-r + 140)
                .attr("y", center[1]-1.2*r)
                .attr("font-size", "30px")
                .attr("fill", "black")
                .text("Questions Posted: " + total);
            svg.append("text")
                .attr("class", "right_text")
                .attr("x", center2[0]-r + 140)
                .attr("y", center2[1]-1.2*r)
                .attr("font-size", "30px")
                .attr("fill", "black")
                .text("Questions Posted: " + total);
            make_inner_data();
            maxes = [];
            makeQuarts(innerQuarts, month_data, 0, 12, false);
            makeQuarts(middleQuarts, week_data, middle_min_idx, middle_max_idx, false);
            makeQuarts(outterQuarts, day_data, outter_min_idx, outter_max_idx, false);
            set_Y_hist(false);
            set_Y_hist2(false);
            set_yScaleWeek(13);
            
            add_row_to_table("Month", innerQuarts, maxes[0], null, null, null);
            add_row_to_table("Week", middleQuarts, maxes[1], null, null, null);
            add_row_to_table("Day", outterQuarts, maxes[2], "Day", dayQuarts[13], yMaxDay[13]);
            add_row_to_table("Hour", histQuarts, maxes[3], "Hour", weekQuarts[13], yMaxWeek[13]);
            hist = svg.selectAll(".bar")
                .data(hour_data)
                .enter().append("g")
                .attr("class", "bar");
            hist.append("rect")
                .attr("x", function(d){
                    d.a = (d[0]+1-hist_min_idx)*2*Math.PI/num_recs()-Math.PI/2;
                    var pos_on_circle = getPointOnCircle(d.a, r);
                    d.x = pos_on_circle[0];
                    d.y = pos_on_circle[1];
                    d.a = (d[0]+0.5-hist_min_idx)*2*Math.PI/num_recs()-Math.PI/2;

                    return d.x;
                })
                .attr("y", function(d){
                    return d.y;
                })
                .attr("width", function(d){
                    if(d[0] >= hist_min_idx && d[0] < hist_max_idx)
                        return circumference/num_recs();
                    return 0;
                })
                .attr("height", function(d){
                    return yScale(d[1]);
                })
                .attr("stroke", "none")
                .attr("fill", function(d) { 
                    return get_color(histQuarts, d[1]);
                })
                .on("mouseover", function(d){
                    d3.select(".left_text").text("Questions Posted: " + d[1]);
                })
                .attr("transform", function(d){
                    return "rotate(" + (d.a*360/(2*Math.PI)-90) + "," + d.x + "," + d.y + ")";
                });

            hist2 = svg.selectAll(".bar2")
                .data(cycle_data[13])
                .enter().append("g")
                .attr("class", "bar2");
            hist2.append("rect")
                .attr("x", function(d){
                    d.a = (d[0]+1)*2*Math.PI/168-Math.PI/2;
                    var pos_on_circle = getPointOnCircle2(d.a, r);
                    d.x = pos_on_circle[0];
                    d.y = pos_on_circle[1];
                    d.a = (d[0]+0.5)*2*Math.PI/168-Math.PI/2;

                    return d.x;
                })
                .attr("y", function(d){
                    return d.y;
                })
                .attr("width", function(d){
                    if(d[0] >= 0 && d[0] < 168)
                        return circumference/168;
                    return 0;
                })
                .attr("height", function(d){
                    return yScaleWeek(d[1]);
                })
                .attr("stroke", "none")
                .on("mouseover", function(d){
                    d3.select(".right_text").text("Questions Posted: " + d[1]);
                })
                .attr("fill", function(d) { 
                    return get_color(weekQuarts[13], d[1]);
                })
                .attr("transform", function(d){
                    return "rotate(" + (d.a*360/(2*Math.PI)-90) + "," + d.x + "," + d.y + ")";
                });

            week_circle = svg.selectAll(".week_circle")
                .data(week_cycle_data[13])
                .enter().append("g")
                .attr("class", "week_circle")
                .attr("transform", "translate(" + center2[0] + "," + center2[1] + ")");
            week_circle.append("path")
                .attr("d", function(d){
                    return arc([d[0], 7, r, r*2/3, 0, 7]);
                })
                .attr("stroke", "black")
                .attr("fill", function(d){return get_color(dayQuarts[13], d[1]);})
                .on("mouseover", function(d){
                    d3.select(".right_text").text("Questions Posted: " + d[1]);
                })
            var angle;
            var slocation;
            var count = 5;
            days_of_week = ["Monday", "Tuesday","Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
           
            d3.selectAll(".day_num2").remove();
            for(i = 1; i <= 7; i++){
                angle = (count+0.5-0.01*(Math.min(Math.abs(i-1), 7-(Math.abs(i-1)))))*2*Math.PI/7;
                slocation = getPointOnCircle2(angle, r*0.85);

                svg.append("text")
                    .attr("class", "day_num2")
                    .attr("fill", "white")
                    .attr("x", slocation[0])
                    .attr("y", slocation[1])
                    .attr("font-size", "20px")
                    .attr("transform", function(){
                        angle = angle*360/(2*Math.PI);
                        return "rotate(" + (angle+100) + "," + slocation[0] + "," + slocation[1] + ")";
                    })
                    .text(days_of_week[i-1]);
                count++;
            }
            outter_circle = svg.selectAll(".outter_circle")
                .data(day_data)
                .enter().append("g")
                .attr("class", "outter_circle")
                .attr("transform", "translate(" + center[0] + "," + center[1] + ")");

            outter_circle.append("path")
                .attr("d", function(d){
                    return arc([d[0], 365, r, r*.75, outter_min_idx, outter_max_idx]);
                })
                .attr("stroke", "black")
                .attr("fill", function(d){return get_color(outterQuarts, d[1]);})
                .on("mouseover", function(d){
                    d3.select(".left_text").text("Questions Posted: " + d[1]);
                })
                .on("click", function(d){
                    outter_click(d[0]);
                });

            middle_circle = svg.selectAll(".middle_circle")
                .data(week_data)
                .enter().append("g")
                .attr("class", "middle_circle")
                .attr("transform", "translate(" + center[0] + "," + center[1] + ")");

            middle_circle.append("path")
                .attr("d", function(d){
                    return arc([d[0], 52, r*.75, r*.5, middle_min_idx, middle_max_idx])
                })
                .attr("stroke", "black")
                .attr("fill", function(d){return get_color(middleQuarts, d[1]);})
                .on("mouseover", function(d){
                    d3.select(".left_text").text("Questions Posted: " + d[1]);
                })
                .on("click", function(d){
                    middle_click(d[0]);
                });

            inner_circle = svg.selectAll(".inner_circle")
                .data(month_data)
                .enter().append("g")
                .attr("class", "inner_circle")
                .attr("transform", "translate(" + center[0] + "," + center[1] + ")");


            inner_circle.append("path")
                .attr("d", function(d){
                    return arc([d[0], 12, r*.5, r*.25, 0, 12])
                })
                .attr("stroke", "black")
                .attr("fill", function(d){return get_color(innerQuarts, d[1]);})
                .on("mouseover", function(d){
                    d3.select(".left_text").text("Questions Posted: " + d[1]);
                })
                .on("click", function(d){
                    inner_click(d[0]);
                });

            //week_circle = svg.selectAll(".week_circle")
            //    .data(week_cycle_data)
            
            var angle;
            var slocation;
            var count = 9;
            months.forEach(element => {
                angle = (count+0.6)*2*Math.PI/12;
                slocation = getPointOnCircle(angle, r*0.3);

                svg.append("text")
                    .attr("fill", "white")
                    .attr("x", slocation[0])
                    .attr("y", slocation[1])
                    .attr("font-size", "20px")
                    .attr("transform", function(){
                        angle = angle*360/(2*Math.PI);
                        return "rotate(" + angle + "," + slocation[0] + "," + slocation[1] + ")";
                    })
                    .text(element);
                count++;
            });
            draw_circles();
            
            svg.append("text")
                .attr("x", center[0]-r*0.10)
                .attr("y", center[1]-r*0.55)
                .attr("font-size", "20px")
                .attr("fill", "#ffff00")
                .text("Week");
            
            svg.append("text")
                .attr("x", center[0]-r*0.07)
                .attr("y", center[1]-r*0.80)
                .attr("font-size", "20px")
                .attr("fill", "#ffff00")
                .text("Day");
        });
        function get_circle_points(radius, center){
            var circle_points = [];
            for(i = 0; i < 1000; i++){
                circle_points.push([Math.cos(2*Math.PI*i/1000)*radius+center[0], Math.sin(2*Math.PI*i/1000)*radius+center[1]]);
            }
            circle_points.push([radius+center[0], center[1]]);
            return circle_points;
        }
        function getPointOnCircle(angle, radius){
            return [Math.cos(angle)*radius+center[0], Math.sin(angle)*radius+center[1]];
        }
        function getPointOnCircle2(angle, radius){
            return [Math.cos(angle)*radius+center2[0], Math.sin(angle)*radius+center2[1]];
        }
        function reset_select(){
            outter_select = -1;
            middle_select = -1;
            inner_select = -1;
            
            d3.selectAll(".day_num").remove();
            d3.selectAll(".week_num").remove();
        }
        function reset_data(array){
            for(i = 0; i < array.length; i++)
                array[i][1] = 0;
        }
        function make_inner_data(){
            middle_min_idx = 0;
            outter_min_idx = 0;
            hist_min_idx = 0;
            middle_max_idx = 52;
            outter_max_idx = day_data.length;
            hist_max_idx = hour_data.length;
        }
        function make_middle_data(){
            middle_min_idx = 52+inner_select*4;
            middle_max_idx = middle_min_idx+4;
            outter_min_idx = cum_days[inner_select+1];
            outter_max_idx = outter_min_idx + days_per_month[inner_select];
            hist_min_idx = outter_min_idx*24;
            hist_max_idx = outter_max_idx*24;
        }
        function make_outter_data(){
            if(inner_select == -1)
                outter_min_idx = middle_select*7;
            else
                outter_min_idx = cum_days[inner_select+1]+7*((middle_select-52)%4);
            outter_max_idx = outter_min_idx+7;
            hist_min_idx = outter_min_idx*24;
            hist_max_idx = outter_max_idx*24;
        }
        function makeQuarts(quarts, data_array, min_idx, max_idx, use_min1){
            var max = 0;
            for(i = min_idx; i < max_idx; i++){
                if(data_array[i][1] > max)
                    max = data_array[i][1];
            }
            maxes.push(max);
            var min1 = max;
            var min2 = max;
            for(i = min_idx; i < max_idx; i++){
                if(data_array[i][1] < min1){
                    min2 = min1;
                    min1 = data_array[i][1];
                }
                else if(data_array[i][1] < min2){
                    min2 = data_array[i][1];
                }
            }
            var dec = 1/(quarts.length+1);
            if(use_min1){
                for(i = 0; i < quarts.length; i++){
                    quarts[i] = (max-min1)*dec*(i+1)+min1;
                }
            }
            else{
                for(i = 0; i < quarts.length; i++){
                    quarts[i] = (max-min2)*dec*(i+1)+min2;
                }
            }
        }
        function set_Y_hist(use_min1){
            yMin1 = 9999999;
            yMin2 = 9999999;
            yMax = 0;
            for(i = hist_min_idx; i < hist_max_idx; i++){
                if(hour_data[i][1] < yMin1){
                    yMin2 = yMin1;
                    yMin1 = hour_data[i][1];
                }
                else if(hour_data[i][1] < yMin1)
                    yMin2 = hour_data[i][1];
                if(hour_data[i][1] > yMax)
                    yMax = hour_data[i][1];
            }
            
            maxes.push(yMax);
            yScale = d3.scaleLinear()
                .domain([yMin1, yMax])
                .range([0, d3.min([width,height])*.25/4]);
                
            var dec = 1/(histQuarts.length+1);
            if(use_min1){
                for(i = 0; i < histQuarts.length; i++){
                    histQuarts[i] = (yMax-yMin1)*dec*(i+1)+yMin1;
                }
            }
            else{
                for(i = 0; i < histQuarts.length; i++){
                    histQuarts[i] = (yMax-yMin2)*dec*(i+1)+yMin2;
                }
            }
        }
        function set_yScaleWeek(index){
            yScaleWeek = d3.scaleLinear()
                .domain([yMinWeek[index], yMaxWeek[index]])
                .range([0, d3.min([width,height])*.25/4]);

            var dec = 1/(weekQuarts[0].length+1);
            for(j = 0; j < 14; j++){
                for(i = 0; i < weekQuarts[j].length; i++){
                    weekQuarts[j][i] = (yMaxWeek[j]-yMinWeek[j])*dec*(i+1)+yMinWeek[j];
                }
            }
            
            for(j = 0; j < 14; j++){
                for(i = 0; i < dayQuarts[j].length; i++){
                    dayQuarts[j][i] = (yMaxDay[j]-yMinDay[j])*dec*(i+1)+yMinDay[j];
                }
            }
        }
        function set_Y_hist2(){
            yMinWeek = [];
            yMaxWeek = [];
            for(i = 0; i < 14; i++){
                yMinWeek.push(d3.min(cycle_data[i], function(d){return d[1]}));
                yMaxWeek.push(d3.max(cycle_data[i], function(d){return d[1]}));
            }
            yMinDay = [];
            yMaxDay = [];
            for(i = 0; i < 14; i++){
                yMinDay.push(d3.min(week_cycle_data[i], function(d){return d[1]}));
                yMaxDay.push(d3.max(week_cycle_data[i], function(d){return d[1]}));
            }
        }
        function get_color(array, value){
            if(value < array[0])
                return heat_colors[0];
            if(value < array[1])
                return heat_colors[1];
            if(value < array[2])
                return heat_colors[2];
            return heat_colors[3];
        }
        function get_gone_color(array, value){
            if(value < array[0])
                return gone_colors[0];
            if(value < array[1])
                return gone_colors[1];
            if(value < array[2])
                return gone_colors[2];
            return gone_colors[3];

        }
        function filter_select(choice){
            set_yScaleWeek(choice);
            
            document.getElementById("legend_table").deleteRow(2);
            document.getElementById("legend_table").deleteRow(2);

            add_row_to_table("Day", outterQuarts, maxes[2], "Day", dayQuarts[choice], yMaxDay[choice]);
            add_row_to_table("Hour", histQuarts, maxes[3], "Hour", weekQuarts[choice], yMaxWeek[choice]);

            hist2 = svg.selectAll(".bar2")
                .data(cycle_data[choice])
            hist2.select("rect").transition()
                .duration(1000)
                .attr("height", function(d){
                    return yScaleWeek(d[1]);
                })
                .attr("fill", function(d) { 
                    return get_color(weekQuarts[choice], d[1]);
                });
            week_circle = svg.selectAll(".week_circle")
                .data(week_cycle_data[choice]);
            week_circle.select("path").transition()
                .duration(1000)
                .attr("fill", function(d){return get_color(dayQuarts[choice], d[1]);})
            total2 = 0
            for(i = 0; i<7; i++)
                total2 += week_cycle_data[choice][i][1];
                
            d3.select(".right_text").text("Questions Posted: " + total2);
                
            rep_buts = svg.selectAll(".rep_but")
            rep_buts.select("circle")
                .attr("r", function(d){
                    if(d ==  choice)
                        return r*0.04
                    return r*0.025
                })
                .attr("fill",function(d){
                    if(d ==  choice)
                        return "#cc6600"
                    return "#666666"
                })
        }
        function inner_click(choice){
            inner_circle = svg.selectAll(".inner_circle").data(month_data);
            inner_circle.select("path").transition()
                .duration(transition_time)
                .attr("fill", function(d){
                    if(d[0] == choice)
                        return select_color;
                    return get_gone_color(innerQuarts, d[1]);
                });
            console.log(month_data[choice]);
            inner_select = choice;
            middle_select = -1;
            outter_select = -1;
            make_middle_data();
            
            middle_circle = svg.selectAll(".middle_circle").data(week_data);
            middle_circle.select("path").transition()
                .duration(transition_time)
                .attr("d", function(d){
                    return arc([d[0], 4, r*.75, r*.5, middle_min_idx, middle_max_idx]);
                })
                .attr("fill", function(d){return get_color(middleQuarts, d[1]);});
            outter_circle = svg.selectAll(".outter_circle").data(day_data);
            outter_circle.select("path").transition()
                .duration(transition_time)
                .attr("d", function(d){
                    return arc([d[0], days_per_month[inner_select], r, r*.75, outter_min_idx, outter_max_idx]);
                })
                .attr("fill", function(d){return get_color(outterQuarts, d[1]);});

            var angle;
            var slocation;
            var count = days_per_month[choice]*.75;
            d3.selectAll(".day_num").remove();
            for(i = 1; i <= days_per_month[choice]; i++){
                angle = (count+0.6-0.005*i)*2*Math.PI/days_per_month[choice];
                slocation = getPointOnCircle(angle, r*0.85+(Math.min(Math.abs(i-days_per_month[choice]*.25), days_per_month[choice]-Math.abs(i-days_per_month[choice]*.25))));

                svg.append("text")
                    .attr("class", "day_num")
                    .attr("fill", "white")
                    .attr("x", slocation[0])
                    .attr("y", slocation[1])
                    .attr("font-size", "20px")
                    .text(i);
                count++;
            }
            var angle;
            var slocation;
            var count = 4*.75;
            d3.selectAll(".week_num").remove();
            for(i = 1; i <= 4; i++){
                angle = (count+0.6-0.005*i)*2*Math.PI/4;
                slocation = getPointOnCircle(angle, r*0.63);

                svg.append("text")
                    .attr("class", "week_num")
                    .attr("fill", "white")
                    .attr("x", slocation[0])
                    .attr("y", slocation[1])
                    .attr("font-size", "20px")
                    .attr("transform", function(){
                        angle = angle*360/(2*Math.PI);
                        return "rotate(" + (angle+100) + "," + slocation[0] + "," + slocation[1] + ")";
                    })
                    .text("week " + i);
                count++;
            }

            transition_histogram(true);
        }
        function middle_click(choice){
            inner_circle = svg.selectAll(".inner_circle").data(month_data);
            inner_circle.select("path").transition()
                .duration(transition_time)
                .attr("fill", function(d){
                    if(d[0] == inner_select)
                        return select_color;
                    return get_gone_color(innerQuarts, d[1]);
                });
            middle_circle = svg.selectAll(".middle_circle").data(week_data);
            middle_circle.select("path").transition()
                .duration(transition_time)
                .attr("fill", function(d){
                    if(d[0] == choice)
                        return select_color;
                    return get_gone_color(middleQuarts, d[1]);
                });
            middle_select = choice;
            outter_select = -1;
            make_outter_data();
            
            outter_circle = svg.selectAll(".outter_circle").data(day_data);
            outter_circle.select("path").transition()
                .duration(transition_time)
                .attr("d", function(d){
                    return arc([d[0], 7, r, r*.75, outter_min_idx, outter_max_idx]);
                })
                .attr("fill", function(d){return get_color(outterQuarts, d[1]);});

            var angle;
            var slocation;
            var count = 7*.75;
                days_of_week = ["1", "2", "3", "4", "5", "6", "7"];
            if(inner_select == -1)
                days_of_week = ["Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Monday", "Tuesday"];
            else{
                d = cum_days[inner_select+1] + choice*7;
            }
            d3.selectAll(".day_num").remove();
            for(i = 1; i <= 7; i++){
                angle = (count+0.2-0.01*(Math.min(Math.abs(i-1), 7-(Math.abs(i-1)))))*2*Math.PI/7;
                slocation = getPointOnCircle(angle, r*0.85);

                svg.append("text")
                    .attr("class", "day_num")
                    .attr("fill", "white")
                    .attr("x", slocation[0])
                    .attr("y", slocation[1])
                    .attr("font-size", "20px")
                    .attr("transform", function(){
                        angle = angle*360/(2*Math.PI);
                        return "rotate(" + (angle+100) + "," + slocation[0] + "," + slocation[1] + ")";
                    })
                    .text(days_of_week[i-1]);
                count++;
            }
            transition_histogram(true);
        }
        function outter_click(choice){
            inner_circle = svg.selectAll(".inner_circle").data(month_data);
            inner_circle.select("path").transition()
                .duration(transition_time)
                .attr("fill", function(d){
                    if(d[0] == inner_select)
                        return select_color;
                    return get_gone_color(innerQuarts, d[1]);
                });
            middle_circle = svg.selectAll(".middle_circle").data(week_data);
            middle_circle.select("path").transition()
                .duration(transition_time)
                .attr("fill", function(d){
                    if(d[0] == middle_select)
                        return select_color;
                    return get_gone_color(middleQuarts, d[1]);
                });
            outter_circle = svg.selectAll(".outter_circle").data(day_data);
            outter_circle.select("path").transition()
                .duration(transition_time)
                .attr("fill", function(d){
                    if(d[0] == choice)
                        return select_color;
                    return get_gone_color(outterQuarts, d[1]);
                });
            
            hist_min_idx = choice*24;
            hist_max_idx = hist_min_idx+24;
            outter_select = choice;
            transition_histogram(true);
        }
        function transition_histogram(small){
            d3.selectAll(".bar").remove();
            if(small){

                small_hour_data = [];
                for(i = hist_min_idx; i < hist_max_idx; i++)
                    small_hour_data.push([i, hour_data[i][1]]);

                hist = svg.selectAll(".bar")
                    .data(small_hour_data)
                    .enter().append("g")
                    .attr("class", "bar");
            }
            else{
                
                hist = svg.selectAll(".bar")
                    .data(hour_data)
                    .enter().append("g")
                    .attr("class", "bar");
            }
            hist.append("rect")
                .attr("x", function(d){
                    d.a = (d[0]+1-hist_min_idx)*2*Math.PI/num_recs()-Math.PI/2;
                    var pos_on_circle = getPointOnCircle(d.a, r);
                    d.x = pos_on_circle[0];
                    d.y = pos_on_circle[1];
                    d.a = (d[0]+0.5-hist_min_idx)*2*Math.PI/num_recs()-Math.PI/2;

                    return d.x;
                })
                .attr("y", function(d){
                    return d.y;
                })
                .attr("width", function(d){
                    if(d[0] >= hist_min_idx && d[0] < hist_max_idx)
                        return circumference/num_recs();
                    return 0;
                })
                .attr("height", function(d){
                    return yScale(d[1]);
                })
                .attr("stroke", "none")
                .attr("fill", function(d) { 
                    return get_color(histQuarts, d[1]);
                })
                .on("mouseover", function(d){
                    d3.select(".left_text").text("Questions Posted: " + d[1]);
                })
                .attr("transform", function(d){
                    return "rotate(" + (d.a*360/(2*Math.PI)-90) + "," + d.x + "," + d.y + ")";
                });
        }
        function compare(row1, row2){
            if(row1.Month < row2.Month)
                return -1;
            if(row2.Month < row1.Month)
                return 1;
            if(row1.Day < row2.Day)
                return -1;
            if(row2.Day < row1.Day)
                return 1;
            if(row1.Hour < row2.Hour)
                return -1;
            if(row2.Hour < row1.Hour)
                return 1;
            return 0;
        }
        function row_to_week(row){
            return Math.floor((cum_days[row.Month]+row.Day-1)/7);
        }
        function row_to_day(row){
            return cum_days[row.Month]+row.Day-1;
        }
        function week_compare(w, row1){
            var w1 = row_to_week(row1);
            if(w < w1)
                return -1;
            if(w > w1)
                return 1;
            if(row1.Hour == 0)
                return 0;
            return -1;
        }
        function binary_search(val){
            var min = 0;
            var max = data.length;
            var mid;
            var c;
            while(max-min > 1){
                mid = Math.floor((min+max)/2);
                c = compare(val, data[mid])
                switch(c){
                    case 0:
                        return mid;
                    case -1:
                        max = mid;
                        break;
                    case 1:
                        min = mid;
                        break;
                }
            }
            if(compare(val, data[min]) == 0)
                return min;
            if(compare(val, data[max]) == 0)
                return max;
            if(compare(val, data[min]) == -1)
                return min;
            if(compare(val, data[max]) == -1)
                return max;
            return max+1;
        }
        function binary_search_week(w){
            var min = 0;
            var max = data.length;
            var mid;
            var c;
            while(max-min > 1){
                mid = Math.floor((min+max)/2);
                c = week_compare(w, data[mid])
                switch(c){
                    case 0:
                        return mid;
                    case -1:
                        max = mid;
                        break;
                    case 1:
                        min = mid;
                        break;
                }
            }
            if(week_compare(w, data[min]) == 0)
                return min;
            if(week_compare(w, data[max]) == 0)
                return max;
            if(week_compare(w, data[min]) == -1)
                return min;
            if(week_compare(w, data[max]) == -1)
                return max;
            return max+1;
        }
        function num_recs(){
            if(outter_select != -1)
                return 24;
            if(middle_select != -1)
                return 168;
            if(inner_select != -1)
                return days_per_month[inner_select]*24;
            return 8760;
        }
        function draw_circle(ra, c){
            svg.append("svg:circle")
                .attr("cx", c[0])
                .attr("cy", c[1])
                .attr("r", ra)
                .attr("stroke", "black")
                .attr("stroke-width", "3")
                .attr("fill", "none");
        }
        function draw_circles(){
            draw_circle(r, center);
            draw_circle(r*.75, center);
            draw_circle(r*.5, center);
            draw_circle(r, center2);
            draw_circle(r*2/3, center2);
            svg.append("svg:circle")
                .attr("cx", center[0])
                .attr("cy", center[1])
                .attr("r", r*0.25)
                .attr("stroke", "black")
                .attr("stroke-width", "3")
                .attr("fill", "#666666")
                .on("mouseover", function(d){
                    d3.select(this).style("fill", "#333333");
                    d3.select(".left_text").text("Questions Posted: " + total);
                })
                .on("mouseout", function(d){
                    d3.select(this).style("fill", "#666666");
                })
                .on("click", function(d){
                    make_inner_data();
                    reset_select();
                    
                    inner_circle = svg.selectAll(".inner_circle").data(month_data);
                    inner_circle.select("path").transition()
                        .duration(transition_time)
                        .attr("fill", function(d){
                            return get_color(innerQuarts, d[1]);
                         });
            
                    middle_circle = svg.selectAll(".middle_circle").data(week_data);
                    middle_circle.select("path").transition()
                        .duration(transition_time)
                        .attr("d", function(d){
                            return arc([d[0], 52, r*.75, r*.5, middle_min_idx, middle_max_idx]);
                        })
                        .attr("fill", function(d){return get_color(middleQuarts, d[1]);});
                    outter_circle = svg.selectAll(".outter_circle").data(day_data);
                    outter_circle.select("path").transition()
                        .duration(transition_time)
                        .attr("d", function(d){
                            return arc([d[0], 365, r, r*.75, outter_min_idx, outter_max_idx]);
                        })
                        .attr("fill", function(d){return get_color(outterQuarts, d[1]);});

                     transition_histogram(false);
                });
            svg.append("text")
                .attr("x", 0.94*center[0] - 5)
                .attr("y", 1.01*center[1])
                .attr("font-size", "20px")
                .attr("fill", "#ffff00")
                .text("Reset");
        }
        function add_cell(row, text, color){
            row.append("td")
                .text(text)
                .style("font-weight", "bold")
                .style("width", "70")
                .style("color", "white")
                .style("padding", "5px 0px 5px 10px")
                .style("background-color", color);
        }
        function add_row_to_table(lead_word, data, m, lead_word2, data2, m2){
            var row = table.append("tr");
            add_cell(row, "", "#f69c55");
            row.append("td")
                .text(lead_word)
                .style("font-weight", "bold")
                .style("color", "white")
                .style("padding", "5px 5px 5px 5px")
                .style("background-color", "black");
            add_cell(row, " < " + Math.ceil(data[0]), "#000099");
            add_cell(row, " < " + Math.ceil(data[1]), "#4d0099");
            add_cell(row, " < " + Math.ceil(data[2]), "#7a1f5c");
            add_cell(row, " < " + (m+1), "#990000");
            if(lead_word2 != null){
                add_cell(row, "", "#f69c55");
                add_cell(row, "", "#f69c55");
                add_cell(row, "", "#f69c55");
                add_cell(row, "", "#f69c55");
                add_cell(row, "", "#f69c55");
                row.append("td")
                    .text(lead_word2)
                    .style("font-weight", "bold")
                    .style("color", "white")
                    .style("padding", "5px 5px 5px 5px")
                    .style("background-color", "black");
                add_cell(row, " < " + Math.ceil(data2[0]), "#000099");
                add_cell(row, " < " + Math.ceil(data2[1]), "#4d0099");
                add_cell(row, " < " + Math.ceil(data2[2]), "#7a1f5c");
                add_cell(row, " < " + (m2+1), "#990000");
            }
        }
    </script>
</html>
